<!DOCTYPE html>
<html lang="pt-BR">
<head>
<!-- mais info https://world.openfoodfacts.org/api/v0/product/7894900010019.json (fazer copia local)-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de Código de Barras Brasileiro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #009c3b 0%, #ffdf00 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .scanner-container {
            flex: 1;
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 120px;
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #009c3b, #00b341);
            color: white;
            box-shadow: 0 4px 15px rgba(0,156,59,0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ffdf00, #ffd700);
            color: #333;
            box-shadow: 0 4px 15px rgba(255,223,0,0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 4px 15px rgba(231,76,60,0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .camera-container {
            position: relative;
            margin-bottom: 25px;
            border-radius: 15px;
            overflow: hidden;
            background: #000;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #scanner {
            width: 100%;
            height: 100%;
            min-height: 300px;
            border-radius: 15px;
            object-fit: cover;
            background: #000;
        }

        #scanner canvas,
        #scanner video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            border-radius: 15px;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }

        .scanner-overlay::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 120px;
            border: 3px solid #009c3b;
            border-radius: 10px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { border-color: #009c3b; }
            50% { border-color: #ffdf00; }
        }

        .scanner-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            animation: fadeInOut 3s infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .mode-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,156,59,0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            backdrop-filter: blur(10px);
        }

        .mode-indicator.auto {
            background: rgba(0,156,59,0.9);
        }

        .mode-indicator.manual {
            background: rgba(255,223,0,0.9);
            color: #333;
        }

        .results {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid #009c3b;
        }

        .result-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .result-item:hover {
            transform: translateY(-2px);
        }

        .result-item:last-child {
            margin-bottom: 0;
        }

        .barcode-number {
            font-size: 1.4em;
            font-weight: 700;
            color: #009c3b;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .timestamp {
            color: #666;
            font-size: 0.9em;
            font-style: italic;
        }

        .no-results {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 30px;
        }

        .status-message {
            text-align: center;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            font-weight: 500;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b8daff;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                min-width: auto;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
        }

        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #009c3b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🇧🇷 Leitor de Código de Barras</h1>
            <p>Scanner profissional com câmera</p>
        </div>

        <div class="scanner-container">
            <div id="status-message"></div>
            
            <div class="controls">
                <button id="startBtn" class="btn btn-primary">
                    <span class="loader" style="display: none;"></span>
                    Iniciar Câmera
                </button>
                <button id="captureBtn" class="btn btn-secondary" disabled>
                    📸 Capturar
                </button>
                <button id="toggleModeBtn" class="btn btn-secondary" disabled>
                    🔄 Modo Auto
                </button>
                <button id="focusBtn" class="btn btn-secondary" disabled>
                    🔍 Macro
                </button>
                <button id="stopBtn" class="btn btn-danger" disabled>
                    ⏹️ Parar
                </button>
            </div>

            <div class="camera-container">
                <div id="scanner"></div>
                <div class="scanner-overlay">
                    <div class="mode-indicator auto" id="modeIndicator">
                        Modo Automático
                    </div>
                    <div class="scanner-hint" id="scannerHint">
                        Posicione o código de barras dentro do retângulo verde
                    </div>
                </div>
            </div>

            <div class="results">
                <h3 style="margin-bottom: 15px; color: #009c3b;">📋 Códigos Escaneados</h3>
                <div id="results">
                    <div class="no-results">
                        Nenhum código escaneado ainda. Inicie a câmera para começar!
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class BrazilianBarcodeScanner {
            constructor() {
                this.isScanning = false;
                this.autoMode = true;
                this.macroMode = false;
                this.results = [];
                this.lastScannedCode = '';
                this.lastScannedTime = 0;
                this.currentStream = null;
                
                this.initializeElements();
                this.bindEvents();
                this.updateHints();
            }

            initializeElements() {
                this.startBtn = document.getElementById('startBtn');
                this.captureBtn = document.getElementById('captureBtn');
                this.toggleModeBtn = document.getElementById('toggleModeBtn');
                this.focusBtn = document.getElementById('focusBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.resultsDiv = document.getElementById('results');
                this.statusDiv = document.getElementById('status-message');
                this.modeIndicator = document.getElementById('modeIndicator');
                this.scannerHint = document.getElementById('scannerHint');
            }

            bindEvents() {
                this.startBtn.addEventListener('click', () => this.startScanner());
                this.captureBtn.addEventListener('click', () => this.captureBarcode());
                this.toggleModeBtn.addEventListener('click', () => this.toggleMode());
                this.focusBtn.addEventListener('click', () => this.toggleFocus());
                this.stopBtn.addEventListener('click', () => this.stopScanner());
            }

            showStatus(message, type = 'info') {
                this.statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
                setTimeout(() => {
                    this.statusDiv.innerHTML = '';
                }, 5000);
            }

            updateHints() {
                const hints = [
                    'Posicione o código de barras dentro do retângulo verde',
                    'Mantenha a câmera estável para melhor leitura',
                    'Use o botão Macro para objetos muito próximos',
                    'Aproxime ou afaste a câmera se necessário',
                    'Certifique-se de que há boa iluminação',
                    'Código EAN-13 (13 dígitos) é o padrão brasileiro'
                ];
                
                let currentHint = 0;
                setInterval(() => {
                    if (this.isScanning) {
                        this.scannerHint.textContent = hints[currentHint];
                        currentHint = (currentHint + 1) % hints.length;
                    }
                }, 3000);
            }

            async getOptimalCameraConstraints() {
                const baseConstraints = {
                    video: {
                        facingMode: "environment",
                        width: { ideal: 1920, min: 640 },
                        height: { ideal: 1080, min: 480 },
                        aspectRatio: { ideal: 16/9 }
                    }
                };

                // Add advanced camera features for better close-up scanning
                if (this.macroMode) {
                    baseConstraints.video.focusMode = { ideal: "manual" };
                    baseConstraints.video.focusDistance = { ideal: 0.1 }; // Very close focus
                    baseConstraints.video.zoom = { ideal: 2 }; // Digital zoom for macro
                } else {
                    baseConstraints.video.focusMode = { ideal: "continuous" };
                    baseConstraints.video.focusDistance = { ideal: 0.5 }; // Standard focus distance
                }

                // Try to enable advanced camera features
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    
                    if (videoDevices.length > 0) {
                        // Try to use the back camera specifically
                        for (let device of videoDevices) {
                            if (device.label.toLowerCase().includes('back') || 
                                device.label.toLowerCase().includes('rear')) {
                                baseConstraints.video.deviceId = { exact: device.deviceId };
                                break;
                            }
                        }
                    }
                } catch (error) {
                    console.log('Advanced camera selection not available:', error);
                }

                return baseConstraints;
            }
            async startScanner() {
                try {
                    this.startBtn.querySelector('.loader').style.display = 'inline-block';
                    this.startBtn.disabled = true;
                    
                    // Get optimal camera constraints
                    const constraints = await this.getOptimalCameraConstraints();
                    
                    // Test camera access and get stream
                    this.currentStream = await navigator.mediaDevices.getUserMedia(constraints.video ? constraints : { video: true });
                    
                    // Stop the test stream
                    this.currentStream.getTracks().forEach(track => track.stop());
                    
                    // Configure QuaggaJS with enhanced settings for close-up scanning
                    const quaggaConfig = {
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: document.querySelector('#scanner'),
                            constraints: constraints.video || {
                                width: { ideal: 1920, min: 640 },
                                height: { ideal: 1080, min: 480 },
                                facingMode: "environment",
                                aspectRatio: { ideal: 16/9 }
                            },
                            area: { // Define scanning area
                                top: "20%",
                                right: "10%",
                                left: "10%", 
                                bottom: "20%"
                            },
                            singleChannel: false // Use full color for better detection
                        },
                        locator: {
                            patchSize: this.macroMode ? "large" : "medium",
                            halfSample: !this.macroMode, // Full sample for macro mode
                            showCanvas: false,
                            showPatches: false,
                            showFoundPatches: false,
                            showSkeleton: false,
                            showLabels: false,
                            showPatchLabels: false,
                            showBoundingBox: false,
                            boxFromPatches: {
                                showTransformed: false,
                                showTransformedBox: false,
                                showBB: false
                            }
                        },
                        numOfWorkers: navigator.hardwareConcurrency || 4,
                        frequency: this.macroMode ? 5 : 10, // Slower frequency for macro mode
                        decoder: {
                            readers: [
                                "ean_reader",
                                "ean_8_reader",
                                "code_128_reader" // Add Code 128 support
                            ],
                            multiple: false
                        },
                        locate: true,
                        debug: false
                    };
                    
                    Quagga.init(quaggaConfig, (err) => {
                        if (err) {
                            console.error('Erro ao inicializar scanner:', err);
                            this.showStatus('❌ Erro ao acessar a câmera. Tentando configuração alternativa...', 'error');
                            this.tryFallbackCamera();
                            return;
                        }
                        
                        console.log("Scanner inicializado com sucesso");
                        this.isScanning = true;
                        this.updateButtons();
                        this.showStatus(`✅ Câmera iniciada! ${this.macroMode ? '(Modo Macro ativo)' : ''} Aponte para um código de barras.`, 'success');
                        
                        // Apply CSS fixes to ensure video fills container
                        setTimeout(() => {
                            this.adjustVideoDisplay();
                        }, 500);
                        
                        if (this.autoMode) {
                            Quagga.start();
                        }
                    });

                    // Handle successful barcode detection
                    Quagga.onDetected((result) => {
                        if (!this.autoMode) return;
                        
                        const code = result.codeResult.code;
                        const now = Date.now();
                        
                        // Prevent duplicate scans within 2 seconds
                        if (code === this.lastScannedCode && (now - this.lastScannedTime) < 2000) {
                            return;
                        }
                        
                        this.processBarcodeResult(code);
                    });

                } catch (error) {
                    console.error('Erro ao iniciar scanner:', error);
                    this.showStatus('❌ Não foi possível acessar a câmera. Tentando configuração básica...', 'error');
                    this.tryFallbackCamera();
                }
            }

            async tryFallbackCamera() {
                try {
                    // Fallback to basic camera configuration
                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: document.querySelector('#scanner'),
                            constraints: {
                                width: { min: 640 },
                                height: { min: 480 },
                                facingMode: "environment"
                            }
                        },
                        decoder: {
                            readers: ["ean_reader", "ean_8_reader"]
                        }
                    }, (err) => {
                        if (err) {
                            this.showStatus('❌ Câmera não disponível. Verifique as permissões.', 'error');
                            this.resetButtons();
                            return;
                        }
                        
                        this.isScanning = true;
                        this.updateButtons();
                        this.showStatus('✅ Câmera básica iniciada!', 'success');
                        
                        setTimeout(() => {
                            this.adjustVideoDisplay();
                        }, 500);
                        
                        if (this.autoMode) {
                            Quagga.start();
                        }
                    });
                } catch (fallbackError) {
                    this.showStatus('❌ Falha ao inicializar câmera.', 'error');
                    this.resetButtons();
                }
            }

            adjustVideoDisplay() {
                // Force video to fill container properly
                const video = document.querySelector('#scanner video');
                const canvas = document.querySelector('#scanner canvas');
                const container = document.querySelector('#scanner');
                
                if (video) {
                    video.style.width = '100%';
                    video.style.height = '100%';
                    video.style.objectFit = 'cover';
                    // Removed mirror transform to fix reversed movement
                }
                
                if (canvas) {
                    canvas.style.width = '100%';
                    canvas.style.height = '100%';
                    canvas.style.objectFit = 'cover';
                    canvas.style.position = 'absolute';
                    canvas.style.top = '0';
                    canvas.style.left = '0';
                }
                
                if (container) {
                    container.style.position = 'relative';
                    container.style.height = '300px';
                    container.style.overflow = 'hidden';
                }
            }

            captureBarcode() {
                if (!this.isScanning) return;
                
                // Force a single scan
                Quagga.onProcessed((result) => {
                    if (result && result.codeResult && result.codeResult.code) {
                        const code = result.codeResult.code;
                        this.processBarcodeResult(code);
                        // Remove the temporary listener
                        Quagga.offProcessed();
                    }
                });
            }

            processBarcodeResult(code) {
                // Validate Brazilian EAN-13 format
                if (!this.isValidBrazilianBarcode(code)) {
                    this.showStatus('⚠️ Código inválido. Verifique se é um código de barras brasileiro válido.', 'error');
                    return;
                }

                this.lastScannedCode = code;
                this.lastScannedTime = Date.now();

                // Add to results
                this.results.unshift({
                    code: code,
                    timestamp: new Date().toLocaleString('pt-BR'),
                    type: this.getBarcodeType(code)
                });

                // Keep only last 10 results
                if (this.results.length > 10) {
                    this.results = this.results.slice(0, 10);
                }

                this.updateResults();
                this.showStatus(`✅ Código escaneado: ${code}`, 'success');
                
                // Play success sound (if available)
                this.playSuccessSound();
            }

            isValidBrazilianBarcode(code) {
                // Basic validation for EAN-13 (13 digits)
                if (!/^\d{13}$/.test(code)) return false;
                
                // EAN-13 checksum validation
                let sum = 0;
                for (let i = 0; i < 12; i++) {
                    sum += parseInt(code[i]) * (i % 2 === 0 ? 1 : 3);
                }
                const checksum = (10 - (sum % 10)) % 10;
                return checksum === parseInt(code[12]);
            }

            getBarcodeType(code) {
                // Identify common Brazilian product prefixes
                const prefix = code.substring(0, 3);
                
                if (prefix >= '789' && prefix <= '790') {
                    return 'Produto Brasileiro 🇧🇷';
                } else if (prefix >= '000' && prefix <= '019') {
                    return 'Produto EUA/Canadá 🇺🇸🇨🇦';
                } else if (prefix >= '300' && prefix <= '379') {
                    return 'Produto França 🇫🇷';
                } else if (prefix >= '400' && prefix <= '440') {
                    return 'Produto Alemanha 🇩🇪';
                } else if (prefix >= '200' && prefix <= '299') {
                    return 'Uso Interno da Loja 🏪';
                } else {
                    return 'Produto Internacional 🌍';
                }
            }

            playSuccessSound() {
                // Create a simple beep sound
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'square';
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            }

            async toggleFocus() {
                if (!this.isScanning) return;
                
                this.macroMode = !this.macroMode;
                this.focusBtn.textContent = this.macroMode ? '🔍 Normal' : '🔍 Macro';
                
                // Restart scanner with new focus settings
                this.showStatus('🔄 Ajustando foco da câmera...', 'info');
                
                // Stop current scanner
                Quagga.stop();
                
                // Small delay to ensure proper cleanup
                setTimeout(async () => {
                    // Restart with new settings
                    const constraints = await this.getOptimalCameraConstraints();
                    
                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: document.querySelector('#scanner'),
                            constraints: constraints.video || {
                                width: { ideal: 1920, min: 640 },
                                height: { ideal: 1080, min: 480 },
                                facingMode: "environment"
                            }
                        },
                        locator: {
                            patchSize: this.macroMode ? "large" : "medium",
                            halfSample: !this.macroMode
                        },
                        numOfWorkers: navigator.hardwareConcurrency || 4,
                        frequency: this.macroMode ? 5 : 10,
                        decoder: {
                            readers: ["ean_reader", "ean_8_reader", "code_128_reader"]
                        },
                        locate: true
                    }, (err) => {
                        if (err) {
                            console.error('Erro ao ajustar foco:', err);
                            this.showStatus('❌ Erro ao ajustar foco. Continuando com configuração anterior.', 'error');
                            return;
                        }
                        
                        setTimeout(() => {
                            this.adjustVideoDisplay();
                        }, 500);
                        
                        this.showStatus(`✅ Foco ${this.macroMode ? 'macro' : 'normal'} ativado!`, 'success');
                        
                        if (this.autoMode) {
                            Quagga.start();
                        }
                    });
                }, 200);
            }
            toggleMode() {
                this.autoMode = !this.autoMode;
                this.updateModeDisplay();
                
                if (this.autoMode) {
                    Quagga.start();
                    this.showStatus('🔄 Modo automático ativado', 'info');
                } else {
                    Quagga.stop();
                    this.showStatus('🔄 Modo manual ativado - use o botão Capturar', 'info');
                }
            }

            updateModeDisplay() {
                this.modeIndicator.textContent = this.autoMode ? 'Modo Automático' : 'Modo Manual';
                this.modeIndicator.className = `mode-indicator ${this.autoMode ? 'auto' : 'manual'}`;
                this.toggleModeBtn.textContent = this.autoMode ? '🔄 Modo Manual' : '🔄 Modo Auto';
            }

            updateResults() {
                if (this.results.length === 0) {
                    this.resultsDiv.innerHTML = '<div class="no-results">Nenhum código escaneado ainda.</div>';
                    return;
                }

                this.resultsDiv.innerHTML = this.results.map(result => `
                    <div class="result-item">
                        <div class="barcode-number">${result.code}</div>
                        <div style="color: #666; font-size: 0.9em; margin: 5px 0;">${result.type}</div>
                        <div class="timestamp">${result.timestamp}</div>
                    </div>
                `).join('');
            }

            updateButtons() {
                this.startBtn.querySelector('.loader').style.display = 'none';
                this.startBtn.disabled = true;
                this.captureBtn.disabled = false;
                this.toggleModeBtn.disabled = false;
                this.focusBtn.disabled = false;
                this.stopBtn.disabled = false;
            }

            resetButtons() {
                this.startBtn.querySelector('.loader').style.display = 'none';
                this.startBtn.disabled = false;
                this.captureBtn.disabled = true;
                this.toggleModeBtn.disabled = true;
                this.focusBtn.disabled = true;
                this.stopBtn.disabled = true;
            }

            stopScanner() {
                if (this.isScanning) {
                    Quagga.stop();
                    
                    // Clean up video stream
                    if (this.currentStream) {
                        this.currentStream.getTracks().forEach(track => track.stop());
                        this.currentStream = null;
                    }
                    
                    // Clear video element
                    const scanner = document.querySelector('#scanner');
                    if (scanner) {
                        scanner.innerHTML = '';
                    }
                    
                    this.isScanning = false;
                    this.macroMode = false;
                    this.focusBtn.textContent = '🔍 Macro';
                    this.resetButtons();
                    this.showStatus('⏹️ Scanner parado.', 'info');
                }
            }
        }

        // Initialize the scanner when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new BrazilianBarcodeScanner();
        });
    </script>
</body>
</html>
