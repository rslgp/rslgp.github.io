<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Shuffler</title>
  <style>
    .img {
      width: 100px;
      height: 100px;
    }
  </style>
</head>

<body>
  <h1>Image Shuffler</h1>
  <input type="file" id="imageInput" accept="image/*">
  <label for="seed">Seed (for randomness):</label>
  <input id="seedInput" value="1234">
  <br>
  <button id="downloadButton" disabled>Download Shuffled Image</button>
  <button id="shuffleButton">Shuffle Image</button>
  <button id="revertButton">Revert Image</button>
  <br>
  <img class="img" id="imageContainerBefore"></img>
  <div class="img" id="imageContainerResult">
  </div>

  <script>
    const imageInput = document.getElementById("imageInput");
    const seedInput = document.getElementById("seedInput");
    const shuffleButton = document.getElementById("shuffleButton");
    const revertButton = document.getElementById("revertButton");
    const imageContainerBefore = document.getElementById("imageContainerBefore");
    const imageContainer = document.getElementById("imageContainerResult");
    const downloadButton = document.getElementById("downloadButton");

    function cloneCanvas(originalCanvas) {
      const newCanvas = document.createElement("canvas");
      const context = newCanvas.getContext("2d", { willReadFrequently: true });

      // Set dimensions of the new canvas to match the original
      newCanvas.width = originalCanvas.width;
      newCanvas.height = originalCanvas.height;

      // Copy image data from original to new canvas
      context.drawImage(originalCanvas, 0, 0);

      return newCanvas;
    }
    function displayImage(canvas) {
      imageContainer.innerHTML = "";
      canvas.classList.add("img");
      imageContainer.appendChild(canvas);



      const denoisedImageData = applyMedianFilter(cloneCanvas(canvas), 1);
      denoisedImageData.classList.add("img");
      imageContainer.appendChild(denoisedImageData);


      downloadButton.disabled = false;
    }
    imageInput.addEventListener("change", function () {
      const image = new Image();
      const seed = seedInput.value;

      // Display original image in separate container
      imageContainerBefore.src = URL.createObjectURL(this.files[0]);

      image.onload = function () {
        // Create canvas with original image dimensions
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d", { willReadFrequently: true });
        canvas.width = image.width;
        canvas.height = image.height;

        // Draw image onto the canvas
        context.drawImage(image, 0, 0);

        // Display canvas in designated container
        displayImage(canvas);
        // revertButton.click();
      };

      image.src = URL.createObjectURL(this.files[0]);
    });

    shuffleButton.addEventListener("click", function () {
      const image = new Image();
      const seed = seedInput.value;

      image.onload = function () {
        imageContainerBefore.src = URL.createObjectURL(imageInput.files[0]);
        const shuffledCanvas = shuffleImage(image, seed, true);
        displayImage(shuffledCanvas);
      };

      image.src = URL.createObjectURL(imageInput.files[0]);
    });

    revertButton.addEventListener("click", function () {
      const canvas = imageContainer.querySelector("canvas");
      if (!canvas) return;

      const seed = seedInput.value;
      const originalCanvas = shuffleImage(canvas, seed, false);
      displayImage(originalCanvas);
      // const denoisedImageData = applyMedianFilter(originalCanvas, 1);
      // displayImage(denoisedImageData);
    });

    downloadButton.addEventListener("click", function () {
      const canvas = imageContainer.querySelector("canvas");
      if (!canvas) return;

      const link = document.createElement("a");
      link.href = canvas.toDataURL("image/png"); // Download as PNG format
      link.download = "shuffled_image.png";
      link.click();
    });
  </script>

  <script src="
https://cdn.jsdelivr.net/npm/seedrandom/seedrandom.min.js
"></script>
  <script>

    function applyMedianFilter(canvas, filterSize) {

      const context = canvas.getContext("2d", { willReadFrequently: true });
      const width = canvas.width;
      const height = canvas.height;
      const imgData = context.getImageData(0, 0, width, height).data
      const newData = new Uint8ClampedArray(imgData.length);

      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          const neighborsR = [];
          const neighborsG = [];
          const neighborsB = [];

          for (let dy = -filterSize; dy <= filterSize; dy++) {
            for (let dx = -filterSize; dx <= filterSize; dx++) {
              const nx = x + dx;
              const ny = y + dy;

              if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                const index = (ny * width + nx) * 4; // RGBA channels
                neighborsR.push(imgData[index]);
                neighborsG.push(imgData[index + 1]);
                neighborsB.push(imgData[index + 2]);
              }
            }
          }

          neighborsR.sort((a, b) => a - b);
          neighborsG.sort((a, b) => a - b);
          neighborsB.sort((a, b) => a - b);

          const medianIndex = Math.floor(neighborsR.length / 2);
          const medianR = neighborsR[medianIndex];
          const medianG = neighborsG[medianIndex];
          const medianB = neighborsB[medianIndex];

          const dataIndex = (y * width + x) * 4;
          newData[dataIndex] = medianR;
          newData[dataIndex + 1] = medianG;
          newData[dataIndex + 2] = medianB;
          newData[dataIndex + 3] = 255; // Alpha channel
        }
      }

      context.putImageData(new ImageData(newData, width, height), 0, 0);
      return canvas;
    }

    function shuffleImage(image, seed, doShuffle) {
      // Error handling for missing arguments
      if (!image || !seed) {
        throw new Error("Missing required arguments: image and seed");
      }

      const canvas = document.createElement("canvas");
      const context = canvas.getContext("2d", { willReadFrequently: true });
      const width = image.width;
      const height = image.height;

      canvas.width = width;
      canvas.height = height;
      context.drawImage(image, 0, 0);

      // Get image data as a Uint8ClampedArray
      const imageData = context.getImageData(0, 0, width, height).data;

      // Generate random permutation based on seed
      // 4 because (r,g,b,a), imageData.length possui blocos de 4 em 4, para pixel 1 [0]->r [1]->g [2]->b [3]->a
      const permutation = generatePermutation(seed, width * height);
      console.log(permutation);
      console.log(imageData.length, width * height, imageData.length / 4);
      // Shuffle or revert pixels based on doShuffle flag
      if (doShuffle) {
        shufflePixels(imageData, permutation);
      } else {
        revertPixels(imageData, permutation);
      }

      // Update canvas with modified image data
      context.putImageData(new ImageData(imageData, width, height), 0, 0);
      return canvas;
    }

    function generatePermutation(seed, size) {
      // Use Math.seedrandom for better randomness with seed
      Math.seedrandom(seed);
      const permutation = new Uint32Array(size);
      for (let i = 0; i < size; i++) {
        permutation[i] = i;
      }

      // Shuffle the permutation array
      for (let i = size - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [permutation[i], permutation[j]] = [permutation[j], permutation[i]];
      }

      return permutation;
    }

    function shufflePixels(imageData, permutation) {
      const tempRed = new Uint8ClampedArray(imageData.length / 4);
      const tempGreen = new Uint8ClampedArray(imageData.length / 4);
      const tempBlue = new Uint8ClampedArray(imageData.length / 4);
      const tempAlpha = new Uint8ClampedArray(imageData.length / 4);

      for (let i = 0; i < imageData.length; i += 4) {
        const shuffledIndex = permutation[i / 4];
        tempRed[shuffledIndex] = imageData[i];
        tempGreen[shuffledIndex] = imageData[i + 1];
        tempBlue[shuffledIndex] = imageData[i + 2];
        tempAlpha[shuffledIndex] = imageData[i + 3];
      }

      for (let i = 0; i < imageData.length; i += 4) {
        imageData[i] = tempRed[i / 4];
        imageData[i + 1] = tempGreen[i / 4];
        imageData[i + 2] = tempBlue[i / 4];
        imageData[i + 3] = tempAlpha[i / 4];
      }
    }


    /*
        function shufflePixels(imageData, permutation) {
          const tempData = new Uint8ClampedArray(imageData.length);
          for (let i = 0; i < imageData.length; i++) {
            tempData[i] = imageData[permutation[i]];
          }
          imageData.set(tempData);
        }*/

    function revertPixels(imageData, permutation) {
      const inversePermutation = new Uint32Array(permutation.length);
      for (let i = 0; i < permutation.length; i++) {
        inversePermutation[permutation[i]] = i;
      }
      shufflePixels(imageData, inversePermutation);
    }

    // Example usage
    const image = new Image(); // Replace with your image loading logic
    image.onload = function () {
      const shuffledCanvas = shuffleImage(image, 1234, true); // Shuffle
      document.body.appendChild(shuffledCanvas);

      const originalCanvas = shuffleImage(shuffledCanvas, 1234, false); // Revert
      document.body.appendChild(originalCanvas);
    };
    image.src = "your_image.jpg"; // Replace with your image source

  </script>
</body>

</html>